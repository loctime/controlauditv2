/* ========= CONTROLAUDIT – OWNER-CENTRIC ========= */

/*
Modelo ÚNICO y definitivo:
apps/auditoria/owners/{ownerId}/...
La seguridad se basa EXCLUSIVAMENTE en:
- request.auth.token.appId == 'auditoria'
- request.auth.token.ownerId
*/

// ================================
// EMPRESAS
// ================================
match /apps/auditoria/owners/{ownerId}/empresas/{empresaId} {

  allow read: if isAuth() && request.auth.token.appId == 'auditoria' && (
    ownerId == uid() ||
    (
      request.auth.token.ownerId == ownerId &&
      resource.data.operarios[uid()] == true
    )
  );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && nonEmptyString("nombre");

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// USUARIOS (admins / operarios)
// ================================
match /apps/auditoria/owners/{ownerId}/usuarios/{userId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      (userId == uid() && request.auth.token.ownerId == ownerId)
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && request.resource.data.role in ['admin', 'operario'];

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// REPORTES (AUDITORÍAS)
// ================================
match /apps/auditoria/owners/{ownerId}/reportes/{reporteId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId ||
      uid() in resource.data.compartidoCon
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid();

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// SUCURSALES
// ================================
match /apps/auditoria/owners/{ownerId}/sucursales/{sucursalId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && nonEmptyString("nombre");

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// FORMULARIOS
// ================================
match /apps/auditoria/owners/{ownerId}/formularios/{formularioId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId ||
      resource.data.esPublico == true ||
      uid() in resource.data.permisos.puedeVer
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && nonEmptyString("nombre");

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// EMPLEADOS
// ================================
match /apps/auditoria/owners/{ownerId}/empleados/{empleadoId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && nonEmptyString("nombre");

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// CAPACITACIONES
// ================================
match /apps/auditoria/owners/{ownerId}/capacitaciones/{capacitacionId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && nonEmptyString("nombre");

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// PLANES CAPACITACIONES ANUALES
// ================================
match /apps/auditoria/owners/{ownerId}/planes_capacitaciones_anuales/{planId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid()
    && nonEmptyString("nombre");

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// REGISTROS ASISTENCIA
// ================================
match /apps/auditoria/owners/{ownerId}/registrosAsistencia/{registroId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid();

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// AUSENCIAS
// ================================
match /apps/auditoria/owners/{ownerId}/ausencias/{ausenciaId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid();

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// ACCIDENTES
// ================================
match /apps/auditoria/owners/{ownerId}/accidentes/{accidenteId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid();

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// LOGS
// ================================
match /apps/auditoria/owners/{ownerId}/logs/{logId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid();

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// AUTOSAVES
// ================================
match /apps/auditoria/owners/{ownerId}/autosaves/{sessionId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && request.resource.data.ownerId == uid();

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid()
    && unchanged("ownerId");

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}

// ================================
// ACCIONES REQUERIDAS (subcolección de sucursales)
// ================================
match /apps/auditoria/owners/{ownerId}/sucursales/{sucursalId}/acciones_requeridas/{accionId} {

  allow read: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && (
      ownerId == uid() ||
      request.auth.token.ownerId == ownerId
    );

  allow create: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();

  allow update: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();

  allow delete: if isAuth()
    && request.auth.token.appId == 'auditoria'
    && ownerId == uid();
}