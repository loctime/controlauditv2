// ================================
// ControlAudit ‚Äì reglas DEV claras
// ================================

// ========= HELPERS APPID =========
// Valida que appId es string y es 'auditoria'
function hasValidAppId() {
  return request.resource.data.appId is string
    && request.resource.data.appId == 'auditoria';
}

// Detecta si el documento existente es legacy (sin appId)
function isLegacyDoc() {
  return !('appId' in resource.data);
}

// Valida que appId coincide entre resource y request.resource
function sameAppId() {
  return resource.data.appId == request.resource.data.appId;
}

// üîê PERFIL
match /apps/auditoria/users/{userId} {
  allow get, create, update: if request.auth != null
    && request.auth.uid == userId;
}

// üîê LISTADO DE SUBCOLECCIONES (ESTA ERA LA PIEZA FALTANTE)
match /apps/auditoria/users/{userId}/{collection} {
  allow list: if request.auth != null
    && request.auth.uid == userId;
}

// üîê DOCUMENTOS DENTRO DE SUBCOLECCIONES
match /apps/auditoria/users/{userId}/{collection}/{docId} {
  allow read, create, update, delete: if request.auth != null
    && request.auth.uid == userId;
}

// üîì Datos generales de la app (excluye expl√≠citamente 'users')
match /apps/auditoria/{collection}/{document=**} {
  // Solo aplicar si NO es 'users' (las rutas de usuarios ya est√°n manejadas arriba)
  allow read: if request.auth != null
    && collection != 'users';
  
  allow create: if request.auth != null
    && collection != 'users'
    && hasValidAppId();
  
  allow update: if request.auth != null
    && collection != 'users'
    && (isLegacyDoc() || (hasValidAppId() && sameAppId()));
  
  allow delete: if request.auth != null
    && collection != 'users';
}

// üìä Colecciones en ra√≠z (empresas, sucursales, auditor√≠as, etc)
match /empresas/{empresaId} {
  allow read, write: if request.auth != null;
}

match /sucursales/{sucursalId} {
  allow read, write: if request.auth != null;
}

match /auditorias/{auditoriaId} {
  allow read, write: if request.auth != null;
}

match /formularios/{formularioId} {
  allow read, write: if request.auth != null;
}

match /empleados/{empleadoId} {
  allow read, write: if request.auth != null;
}

match /accidentes/{accidenteId} {
  allow read, write: if request.auth != null;
}

match /incidentes/{incidenteId} {
  allow read, write: if request.auth != null;
}

match /capacitaciones/{capacitacionId} {
  allow read, write: if request.auth != null;
}

match /reportes/{reporteId} {
  allow read, write: if request.auth != null;
}

match /logs/{logId} {
  allow read, write: if request.auth != null;
}

// ‚ùå Todo lo dem√°s cerrado
match /{document=**} {
  allow read, write: if false;
}
