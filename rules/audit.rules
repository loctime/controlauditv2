// ================================
// ControlAudit ‚Äì reglas DEV claras
// ================================

// ========= HELPERS APPID =========
// Valida que appId es string y es 'auditoria'
function hasValidAppId() {
  return request.resource.data.appId is string
    && request.resource.data.appId == 'auditoria';
}

// Detecta si el documento existente es legacy (sin appId)
function isLegacyDoc() {
  return !('appId' in resource.data);
}

// Valida que appId coincide entre resource y request.resource
function sameAppId() {
  return resource.data.appId == request.resource.data.appId;
}

// üîê Perfil de usuario (SIEMPRE primero)
match /apps/auditoria/users/{userId} {
  allow read, write: if request.auth != null
    && request.auth.uid == userId;
}

// üîì Datos de la app (empresas, auditor√≠as, formularios, etc)
match /apps/auditoria/{document=**} {
  // READ: Solo requiere autenticaci√≥n
  allow read: if request.auth != null;
  
  // CREATE: Exige appId v√°lido
  allow create: if request.auth != null
    && hasValidAppId();
  
  // UPDATE: Permite legacy o exige appId v√°lido y coincidente
  allow update: if request.auth != null
    && (isLegacyDoc() || (hasValidAppId() && sameAppId()));
  
  // DELETE: Solo requiere autenticaci√≥n
  allow delete: if request.auth != null;
}

// üìä Colecciones en ra√≠z (empresas, sucursales, auditor√≠as, etc)
match /empresas/{empresaId} {
  allow read, write: if request.auth != null;
}

match /sucursales/{sucursalId} {
  allow read, write: if request.auth != null;
}

match /auditorias/{auditoriaId} {
  allow read, write: if request.auth != null;
}

match /formularios/{formularioId} {
  allow read, write: if request.auth != null;
}

match /empleados/{empleadoId} {
  allow read, write: if request.auth != null;
}

match /accidentes/{accidenteId} {
  allow read, write: if request.auth != null;
}

match /incidentes/{incidenteId} {
  allow read, write: if request.auth != null;
}

match /capacitaciones/{capacitacionId} {
  allow read, write: if request.auth != null;
}

match /reportes/{reporteId} {
  allow read, write: if request.auth != null;
}

match /logs/{logId} {
  allow read, write: if request.auth != null;
}

// ‚ùå Todo lo dem√°s cerrado
match /{document=**} {
  allow read, write: if false;
}
